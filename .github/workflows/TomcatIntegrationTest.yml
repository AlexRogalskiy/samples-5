name: Tomcat integration test
on:
   push:
      branches:
      - "*"
jobs: 
    tomcat_integration_test:
       runs-on: ubuntu-latest
       steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Create kind cluster
          uses: helm/kind-action@v1.2.0
  
        - name: Apply CRDs
          run: kubectl apply -f tomcat/k8s/crd.yaml

        - name: Set up Java and Maven
          uses: actions/setup-java@v1
          with:
            java-version: 15

        - name: Cache Maven packages
          uses: actions/cache@v2
          with:
            path: ~/.m2
            key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
            restore-keys: ${{ runner.os }}-m2

        - name: Run unit tests
          run: mvn -B test --file tomcat/pom.xml

        - name: Dump state
          if: ${{ failure() }}
          run: |
            kubectl get all -n tomcat-test -o yaml
            kubectl logs curl